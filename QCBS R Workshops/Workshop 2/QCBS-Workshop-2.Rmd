---
title: "QCBS R Workshop 2: Loading and Manipulating Data"
author: Québec Centre for Biodiversity Science
output:
  revealjs::revealjs_presentation:
    css: custom-qcbs.css
    fig_caption: yes
    theme: white
    highlight: haddock
    center: true
    transition: fade
    background_transition: fade
    self_contained: false
    pandoc_args: [ "--slide-level", "2" ]
    reveal_plugins: ["notes", "search", "zoom"]
---

## Quebec Centre for Biodiversity Science
R Workshop Series
Workshop 2: 
Loading and manipulating data

Website: http://qcbs.ca/wiki/r/workshop2

## Learning Objectives

* 1. Writing a script
* 2. Loading, exploring and saving data
* 3. Fixing a broken data frame

## R Scripts

* What is this?
A text file that contains all of the commands that you will use

* Once written and saved, your script file allows you to make changes and re-run analyses with minimal effort!
Just highlight text and click "run" or press command+enter (Mac) or ctrl+enter (PC)


## Create an R script

IMAGE

## Create an R script

IMAGE

## Commands & comments
The '#' symbol in a script tells R to ignore anything remaining on this line of the script when running commands

```{r, eval = FALSE}
# This is a comment not a command
```
###
### commenting / documenting

* annotating someone’s script is a good way to learn
* remember what you did
* tell collaborators what you did
* good step towards reproducible science


## Header
It is recommended that you start your script with a header using comments:

IMAGE


## Section Headings
You can make a section heading in R Studio four # signs

```{r, eval = FALSE}
#### Heading name ####
```

Allows you to move quickly between sections and hide sections

IMAGE

## Housekeeping
The first command at the top of all scripts should be: rm(list = ls()). This:

* Clears R memory
* Prevents errors such as use of older data

###
### Clearing the workspace

```{r, eval = FALSE}
# Clear the R workspace
rm(list=ls())
?rm
?ls
```

## Housekeeping
Demo – add some test data to R and then see how rm(list=ls()) removes it
commenting/documenting

```{r, eval = TRUE, error = TRUE}
A <- "Test"
A
rm(list=ls())
A
```

###
### Remember

* R is ready for commands when you see the chevron '>' in the console. If you don't see it, press ESC
* R is case sensitive!


## Loading, exploring and saving data

## Download today's data

You can download the data & script from:

http://qcbs.ca/wiki/r/workshop2

Save the files somewhere convenient on your computer and remember the path to the directory that contains the files.


## Working Directory

Tells R where your scripts and data are. You need to set the right working directory to load a data file.
Type in the console to see your working directory:

```{r, eval = FALSE}
getwd()
```

When you load a script, RStudio automatically sets the directory to the folder containing the script.

a “/” separates folders and file

## Setting working directory

(Apple Image) 
```{r, eval = FALSE}
setwd('/Users/vincentfugere/Desktop/QCBS_R')
```
(Windows Image) 
```{r, eval = FALSE}
setwd('C:/Users/Johanna/Documents/PhD/R_Workshop2')
```

Alternatively: 
```{r, eval = FALSE}
setwd(choose.dir())
```
This gives you a pop up to navigate to appropriate directory (might not work on a mac).

You can also set your working directory by clicking on session / set working directory / choose directory


## Display contents of the directory

You can display contents of the working directory using dir().

```{r, eval = FALSE}
dir()
```

It helps to:

* Check that the file you plan to open is present in the folder that R is currently working in
* Check for correct spelling (e.g. "co2_good.csv" instead of "CO2_good.csv")


## Importing Data

Import data into R using read.csv:

```{r, eval = TRUE}
CO2 <- read.csv("co2_good.csv", header=TRUE)
```

New object in R
File name within quotation marks ('file' or "file")
Tells R that first line contains column names not data

Recall: to find out what arguments the function requires, use help “?”

```{r, eval = FALSE}
?read.csv2
```

Important: if your operating system or CSV editor (e.g. Excel) is in French, then use read.csv2

```{r, eval = FALSE}
?read.csv2
```

## Importing Data

IMAGE

Notice that R-Studio now provides information on the CO2 data in your workspace

The workspace refers to all the objects that you create during an R session.


## Looking at Data

R code  					| action
----------------- | -------------
CO2					  		| look at the whole dataframe
head(CO2)		  		| look at the first few rows
names(CO2)				| names of the columns in the dataframe
attributes(CO2)		| attributes of the dataframe
ncol(CO2)					| number of columns
nrow(CO2)					| number of rows
summary(CO2)			| summary statistics

Note: the CO2 dataset includes repeated measurements of CO2 uptake from six plants from Quebec and six plants from Mississippi at several levels of ambient CO2 concentration. Half the plants of each type were chilled overnight before the experiment was conducted.


## Looking at Data

```{r, eval = TRUE}
str(CO2)
```
This shows the structure of the dataframe.

Very useful to check data type (mode) of all columns to make sure R loaded data properly. 

**Common problems:**

* Factors loaded as text (character) or vice versa
* Factor includes too many levels because of typo
* Data (integer or numeric) is loaded as character because of typo (e.g. a space or a "," instead of a "." for decimal numbers)


## Looking at Data

data(), head(), str(), names(), attributes(), summary(), ncol(), nrow()

Load the data with: 

```{r, eval = FALSE}
CO2 <- read.csv("CO2_good.csv", header = FALSE)
```
Check data types with str() again. What is wrong here? 

*(Don't forget to re-load data with* **header = T** *afterward)*

## Reminder from Workshop 1: Accessing data

A data frame called *mydata*

IMAGE

```{r, eval = FALSE}
mydata[1,]
```
Extracts the first row

```{r, eval = FALSE}
mydata[2,3]
```
Extracts the content of row 2 / column 3

```{r, eval = FALSE}
mydata[,1]
```
```{r, eval = FALSE}
mydata$Variable1
```
Both extract the first column


## Data exploration
Plot of all variable combinations (very useful!)

```{r, eval = FALSE}
plot(CO2)
```

Want to see if one of your variable is normally distributed? Try hist()

```{r, eval = FALSE}
hist(CO2$uptake)
```

*Recall from workshop 1 that the dollar sign is used to extract a column from a data frame.


## Data exploration

Calculate and save the mean of one of your columns

```{r, eval = TRUE}
conc_mean <- mean(CO2$conc)
```
New object (name)
Function
Data frame (name)
Column (name)

Run object name to see output

```{r, eval = TRUE}
conc_mean
```

Try with standard deviation as well:

```{r, eval = TRUE}
sd(CO2$conc)
```
Mean concentration is 435 and standard deviation is 295.92!


## Data exploration

IMAGE: rubiks cube

Use apply() to calculate the means of the last two columns of the data frame (i.e. the columns that contain continuous data)

```{r, eval = FALSE}
?apply
```


## Data exploration

IMAGE: rubiks cube

Use apply() to calculate the means of the last two columns of the data frame (i.e. the columns that contain continuous data)

```{r, eval = FALSE}
?apply
```
```{r, eval = FALSE}
apply(CO2[,4:5], MARGIN = 2, FUN = mean)
```


## Saving your Workspace

Save

```{r, eval = TRUE}
# Saving an R workspace file
save.image(file="CO2_project_Data.RData")
```

Clear

```{r, eval = TRUE}
# Clear your memory
rm(list = ls())
```

Reload

```{r, eval = TRUE}
# Reload your data
load("CO2_project_Data.RData")
head(CO2) # looking good!
```

## Exporting data

```{r, eval = TRUE}
write.csv(CO2,file="CO2_new.csv")
```
Object (name)
File to write (name)

## Preparing data for R

Comma separated files (.csv) in Data folder

* can be created from almost all applications (Excel, LibreOffice, GoogleDocs)
* file -> save as csv…

IMAGE

## Preparing data for R
Short informative column headings
> - starting with a letter
> - no spaces

IMAGE


## Preparing data for R

Column values match their intended use

* No text in numeric columns
    * do not include spaces!
    * NA (not available) is allowed, but blank entries will automatically be replaced with NA so no need to add yourself.
* Avoid numeric values for data that does not have numeric meaning
    * Subject, Replicate, Treatment: 1,2,3 -> A,B,C or S1,S2,S3 or …

IMAGE

## Preparing data for R
* no notes!
* no additional headings!
* no merged cells!

IMAGE

## Preparing data for R

It is possible to do all your data preparation work within R

* Saves time for large datasets
* Keeps original data intact
* Can switch between long and wide easily (more on this in workshop 4)
* Useful page: https://www.zoology.ubc.ca/~schluter/R/data/ 


## Use your data
IMAGE: rubiks cube

* Try to load, explore, plot, and save your own data in R*
* If it doesn’t load properly, try to make the appropriate changes
* Remember to clear your workspace first!
* When you are finished, try opening your exported data in excel

*If you don’t have your own data, work with your neighbour


## Fixing a broken data frame

##Harder Challenge

IMAGE: rubiks cube

Read in the file "CO2_broken.csv"

```{r, eval = TRUE}
CO2 <- read.csv("co2_broken.csv")
head(CO2)
CO2
```

* This is probably what your data or the data you downloaded looks like
* You can fix the data frame in R (or not…) 
* Please give it a try before looking at the script provided
* Work with your neighbors and have FUN!


## Fixing CO2_broken
IMAGE: rubiks cube

*   ?read.csv - look at some of the options for how to load a .csv

*   head() 

*   str() 

*   class()

*   unique()

*   levels()

*   which()

*   droplevels()

HINT: There are 4 problems!


## Broken data

ERROR 1

The data appears to be lumped into one column

```{r, eval = TRUE}
head(CO2)
```

## Broken data

ERROR 1 - Solution

* Re-import the data, but specify the separation among entries
* The sep argument tells R what character separates the values on each line of the file
* Here, "TAB" was used instead of ","

```{r, eval = TRUE}
CO2 <- read.csv("co2_broken.csv",sep = "")
```

## Broken data

ERROR 2

The data does not start until the third line of the file, so you end up with notes on the file as the headings.

```{r, eval = TRUE}
head(CO2)
```

SOLUTION

Skip two lines when loading the file using the "skip" argument:

```{r, eval = TRUE}
CO2<-read.csv("co2_broken.csv", sep = "", skip = 2)
head(CO2)
```

## Broken data

ERROR 3

"conc" and "uptake" variables are considered factors instead of numbers, because there are comments in the numeric columns

```{r, eval = TRUE}
str(CO2)
```

* Due to missing values entered as "cannot_read_notes" and "na"
* Recall that R only recognizes "NA" (capital)

## read.csv

```{r, eval = FALSE}
?read.csv
```
IMAGE


## Broken data

ERROR 3 - SOLUTION

Tell R that all of NA, "na", and "cannot_read_notes" should be considered NA. Then because all other values in those columns are numbers, $conc and $uptake will be loaded as numeric/integer.


```{r, eval = TRUE}
CO2 <- read.csv("co2_broken.csv", 
sep = "",
skip = 2,
na.strings = c("NA","na","cannot_read_notes"))

str(CO2)
```

## Broken data

ERROR 4

There are only two treatments (chilled and nonchilled) but there are spelling errors causing it to look like 4 different treatments.

```{r, eval = FALSE}
str(CO2)
```

```{r, eval = TRUE}
levels(CO2$Treatment)
unique(CO2$Treatment)
```

## Broken data

ERROR 4 - SOLUTION

Identify all rows that contain "nnchilled" and replace with "nonchilled"
```{r, eval = TRUE}
CO2$Treatment[CO2$Treatment=="nnchilled"] <- "nonchilled"
```

Identify all rows that contain "chiled" and replace with "chilled"
```{r, eval = TRUE}
CO2$Treatment[CO2$Treatment=="chiled"] <- "chilled"
```

Drop unused levels from factor
```{r, eval = TRUE}
CO2 <- droplevels(CO2)
str(CO2)
```

Fixed!


## Thank you for attending, and please provide us with feedback to help us improve the workshop series!

Feedback: http://tinyurl.com/QCBS-R-Comment
